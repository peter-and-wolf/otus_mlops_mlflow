# otus_mlops_mlflow

## Запуск MLFlow в Яндекс-облаке

### Сервисный аккаунт

1. Создаем сервисный аккаунт, называем его, например, `otus-mlflow`.
1. Назначаем аккаунту роли `storage.viewer` и `storage.admin`, с помощью которых он сможет взаимодействовать с S3-бакетами.
1. Создаем статические ключ доступа для аутентификации в облаке от имени аккаунта `otus-mlflow`. При этом не забываем, что значение секретного ключа нужно сохранить до того, как закроется модальное окно, в котором он отображается. 

### Виртуальная машина для MLFlow

1. Создаем виртуальную машину, образ – Ubuntu 24.04, 2 vCPU, 2 GB RAM (для академических целей этого хватит), выбираем default-подсеть (если используете свою подстеть, то насторойте для нее [NAT-шлюз](https://yandex.cloud/ru/docs/vpc/operations/create-nat-gateway)), в поле `Публичный IP-адрес` оставляем `Автоматически`.
1. Выбираем доступ по SSH-ключу, в поле `Логин` указывайте имя своего пользователя (у меня `peter`), давите на кнопку `Добавить ключ`, в открывшееся диалоговое окно копируйте свой публичный ключ. 
1. В поле `Имя ВМ` вставьте осмысленное имя, например, `otus-mlflow-vm`. 
1. Жмем `создать ВМ`, ждем, пока она создается.

Когда виртуалка заведется, проверьте, что можете на нее зайти. Команда такая: `ssh {ИМЯ ПОЛЬЗОВАТЕЛЯ}@{БЕЛЫЙ_IP_ВМ}`.

### Управляемый кластер БД

1. Выберете создать ресурс `Managed Service for PostgreSQL`
1. Укажите имя кластера, например, `otus-mlops-bd`.
1. Выберете конфигурацию кластера: `s3-c2-m8`.
1. Укажите имя БД `mlflow`, имя пользователя БД `mlflow`, задайте пароль на ваш вкус, например, `NoPasaran1983`. 
1. Жмите `Создать кластер`, ждите.

### S3-бакет

1. Создайте бакет, назовите, например, `otus-mlflow-bucket`.
1. Создайте в бакете папку `artifacts`.

### Запуск MLFlow-сервера

1. Зайдите на виртуалку `otus-mlflow-vm`.
1. Создайте директорию: 

    ```bash
    mkdir mlflow && cd mlflow
    ```

1. Создайте виртуальное окружение: 

    ```bash
    python3 -m venv .venv
    ```

    Если потребует установить соответствующий python-venv-пакет, сделайте это, например: 

    ```bash 
    sudo apt install python3.12-venv
    ```

1. Активируйте окружение:

    ```bash
    source ./venv/bin/activate
    ```

1. Установите необходимые python-пакеты:

    ```bash
    pip install mlflow boto3 psycopg2-binary pandas 
    ```

1. Настройте доступ к S3-бакету:

    1. Откройте файл `/etc/environment` (файл системный, используйте `sudo`), добавьте в него:

        ```bash
        MLFLOW_S3_ENDPOINT_URL=https://storage.yandexcloud.net/
        MLFLOW_TRACKING_URI=http://{СЕРЫЙ_IP_ВМ}:8000
        ```
    1. Укажите ключи доступа к бакету от имени вашего сервисного аккаунта:

        Создайте папку `~/.aws`.
        ```bash
        mkdir ~/.aws
        ```
        Создайте в ней файл `~/.aws/credentials` и сохраните в нем следующее:
        ```bash
        [default]
        aws_access_key_id={ИДЕНТИФИКАТОР_СЕКРЕТНОГО_КЛЮЧА}
        aws_secret_access_key={СЕКРЕТНЫЙ_КЛЮЧ}
        ```
1. Запустите MLFlow-сервер:

    ```bash
    mlflow server --backend-store-uri postgresql://{ИМЯ_ПОЛЬЗОВАТЕЛЯ_БД}:{ПАРОЛЬ_БД}@{{ХОСТ_БД}}:6432/{ИМЯ_БД}?sslmode=verify-full --default-artifact-root s3://{ИМЯ_БАКЕТА}/artifacts -h 0.0.0.0 -p 8000
    ````
    Здесь:
    * __ИМЯ_ПОЛЬЗОВАТЕЛЯ_БД__ – имя пользователя, которое вы указали, когда создавали кластер БД (в этой инструкции `mlflow`);
    * __ПАРОЛЬ_БД__ – пароль для доступа к БД, который вы указали, когда создавали кластер БД;
    * __ИМЯ_БД__ – имя БД, которое вы указали, когда создавали кластер БД (в этой инструкции `mlflow`);
    * __ИМЯ_БАКЕТА__ – имя S3-бакета, которое вы указали, когда создавали S3-бакет (в этой инструкции `otus-mlflow-bucket`);


